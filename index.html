<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é£²æ–™é»é¤ç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #ff6b6b, #feca57);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      border-radius: 10px;
      background: #f8f9fa;
      border-left: 4px solid #667eea;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }

    select, input[type="text"], input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    }

    .btn-success {
      background: linear-gradient(45deg, #48cae4, #0077b6);
    }

    .menu-item {
      background: white;
      margin-bottom: 15px;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #eee;
      transition: all 0.3s;
    }

    .menu-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .menu-item.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .drink-info {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .drink-info input[type="radio"] {
      margin-right: 10px;
      transform: scale(1.2);
    }

    .drink-name {
      font-weight: 600;
      font-size: 1.1em;
      color: #333;
    }

    .drink-price {
      color: #ff6b6b;
      font-weight: 700;
      margin-left: 10px;
    }

    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .option-group label {
      font-size: 14px;
      margin-bottom: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    th {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      font-weight: 600;
      text-align: left;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .order-actions {
      display: flex;
      gap: 5px;
    }

    .total-section {
      background: linear-gradient(45deg, #48cae4, #0077b6);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
    }

    .total-amount {
      font-size: 2em;
      font-weight: 700;
    }

    .search-box {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1000;
      border: 1px solid #ddd;
      overflow: hidden;
    }

    .dropdown-item {
      display: block;
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .dropdown-item:hover {
      background: #f8f9fa;
    }

    .dropdown-item:active {
      background: #e9ecef;
    }

    /* å½ˆå‡ºè¦–çª—æ¨£å¼ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5em;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .edit-controls {
      display: flex;
      gap: 15px;
      align-items: end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .edit-controls label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }

    .edit-controls select {
      min-width: 200px;
    }

    .menu-edit-list {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f8f9fa;
      min-height: 300px;
    }

    .edit-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #eee;
    }

    .edit-item input {
      flex: 1;
      margin: 0;
    }

    .edit-item .price-input {
      width: 80px;
    }

    .edit-item .delete-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .edit-item .delete-btn:hover {
      background: #ee5a52;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    /* æ–°çš„èœå–®å¡ç‰‡æ¨£å¼ */
    .menu-items-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .menu-item-card {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .menu-item-card:hover {
      border-color: #667eea;
      box-shadow: 0 8px 15px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }

    .drink-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f8f9fa;
    }

    .drink-name {
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .drink-price {
      font-size: 1.3em;
      font-weight: bold;
      color: #28a745;
      background: #e8f5e8;
      padding: 5px 12px;
      border-radius: 20px;
    }

    .drink-options {
      margin-bottom: 15px;
    }

    .option-row {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }

    .option-group {
      flex: 1;
      min-width: 0;
    }

    .option-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 0.9em;
    }

    .teacher-input, .quantity-select, .sugar-select, .ice-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .teacher-input:focus, .quantity-select:focus, .sugar-select:focus, .ice-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .add-order-section {
      text-align: center;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }

    .add-order-btn {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .add-order-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
    }

    /* åº—å®¶æ¨™ç±¤æ¨£å¼ */
    .store-badge {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      white-space: nowrap;
    }

    /* èœå–®æ§åˆ¶å€åŸŸæ¨£å¼ */
    .menu-controls {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 2px solid #e9ecef;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .teacher-name-section, .search-section {
      flex: 1;
      min-width: 250px;
    }

    .teacher-name-section label, .search-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 1em;
    }

    #global-teacher-name, #drink-search {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    #global-teacher-name:focus, #drink-search:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    /* æœå°‹è¼¸å…¥æ¡†å®¹å™¨ */
    .search-input-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .clear-search-btn {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      color: #999;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .clear-search-btn:hover {
      background: #f0f0f0;
      color: #666;
    }

    .clear-search-btn:active {
      transform: scale(0.95);
    }

    @media (max-width: 768px) {
      /* åŸºç¤å­—é«”å¤§å°èª¿æ•´ */
      body {
        font-size: 16px;
      }

      h1 {
        font-size: 2em;
      }

      h2 {
        font-size: 1.5em;
      }

      h3 {
        font-size: 1.2em;
      }

      /* èœå–®æ§åˆ¶å€åŸŸæ‰‹æ©Ÿå„ªåŒ– */
      .menu-controls {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }

      .teacher-name-section, .search-section {
        min-width: auto;
      }

      .teacher-name-section label, .search-section label {
        font-size: 1.1em;
      }

      #global-teacher-name, #drink-search {
        font-size: 18px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
        padding: 15px;
      }

      /* èœå–®å¡ç‰‡æ‰‹æ©Ÿå„ªåŒ– */
      .menu-items-container {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .menu-item-card {
        padding: 15px;
      }

      .drink-name {
        font-size: 1.3em;
      }

      .drink-price {
        font-size: 1.4em;
        padding: 8px 15px;
      }

      .option-row {
        flex-direction: column;
        gap: 10px;
      }

      .option-group label {
        font-size: 1em;
        margin-bottom: 8px;
      }

      .teacher-input, .quantity-select, .sugar-select, .ice-select {
        font-size: 18px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
        padding: 12px 15px;
      }

      .add-order-btn {
        font-size: 1.2em;
        padding: 15px;
      }

      /* è¡¨æ ¼æ‰‹æ©Ÿå„ªåŒ– */
      table {
        font-size: 14px;
      }

      th, td {
        padding: 8px 4px;
        font-size: 14px;
      }

      /* æŒ‰éˆ•æ‰‹æ©Ÿå„ªåŒ– */
      .btn {
        font-size: 16px;
        padding: 12px 20px;
        min-height: 44px; /* iOS å»ºè­°çš„æœ€å°è§¸æ§å€åŸŸ */
      }

      /* æœå°‹æ¡†æ‰‹æ©Ÿå„ªåŒ– */
      .search-container input {
        font-size: 18px;
        padding: 15px;
      }
    }

    @media (max-width: 768px) {
      .options {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 2em;
      }

      .content {
        padding: 15px;
      }

      .dropdown-content {
        min-width: 180px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ§‹ é£²æ–™é»é¤ç³»çµ±</h1>
      <p>è¼•é¬†ç®¡ç†åœ˜é«”è¨‚é£²æ–™ï¼Œè®“é»é¤è®Šå¾—æ›´ç°¡å–®ï¼</p>
    </div>

    <div class="content">
      <!-- é£²æ–™åº—é¸æ“‡å€åŸŸ -->
      <div class="section">
        <h2>ğŸ“ é¸æ“‡é£²æ–™åº—</h2>
        <div class="form-group">
          <label for="store-select">é£²æ–™åº—ï¼š</label>
          <select id="store-select">
            <option value="">è«‹é¸æ“‡é£²æ–™åº—</option>
            <option value="milkshop">è¿·å®¢å¤ Milk Shop</option>
            <option value="50lan">50åµ</option>
            <option value="comebuy">æ¸…å¿ƒç¦å…¨</option>
            <option value="gongcha">è²¢èŒ¶</option>
            <option value="truedan">çç…®ä¸¹</option>
            <option value="songben">æ¾æœ¬é®®å¥¶èŒ¶</option>
            <option value="seventea">ä¸ƒç›èŒ¶</option>
            <option value="dejeng">å¾—æ­£</option>
            <option value="yimuday">ä¸€æ²æ—¥</option>
            <option value="custom">è‡ªè¨‚èœå–®</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
          <button class="btn" id="upload-menu-btn">ğŸ“ ä¸Šå‚³è‡ªè¨‚èœå–® (CSV)</button>
          <div class="dropdown" style="position: relative;">
            <button class="btn" id="download-menu-btn">ğŸ“¥ ä¸‹è¼‰èœå–®ç¯„æœ¬</button>
            <div class="dropdown-content" id="download-menu-dropdown" style="display: none;">
              <button class="dropdown-item" onclick="downloadMenuTemplate('csv')">ğŸ“„ CSV æ ¼å¼</button>
              <button class="dropdown-item" onclick="downloadMenuTemplate('excel')">ğŸ“Š Excel æ ¼å¼</button>
              <button class="dropdown-item" onclick="downloadMenuTemplate('json')">ğŸ”§ JSON æ ¼å¼</button>
              <button class="dropdown-item" onclick="downloadMenuTemplate('txt')">ğŸ“ æ–‡å­—æ ¼å¼</button>
            </div>
          </div>
          <button class="btn" id="edit-menu-btn">âœï¸ ç·¨è¼¯èœå–®</button>
        </div>
        <input type="file" id="menu-upload" accept=".csv" style="display:none" />
      </div>

      <!-- èœå–®é¡¯ç¤ºå€åŸŸ -->
      <div class="section" id="menu-section" style="display:none">
        <h2>ğŸ¹ èœå–®</h2>

        <!-- è€å¸«å§“åå’Œæœå°‹å€åŸŸ -->
        <div class="menu-controls">
          <div class="teacher-name-section">
            <label for="global-teacher-name">ğŸ‘¨â€ğŸ« è€å¸«å§“åï¼š</label>
            <input type="text" id="global-teacher-name" placeholder="è«‹è¼¸å…¥è€å¸«å§“å" />
          </div>
          <div class="search-section">
            <label for="drink-search">ğŸ” æœå°‹é£²æ–™ï¼š</label>
            <div class="search-input-container">
              <input type="text" id="drink-search" placeholder="è¼¸å…¥é£²æ–™åç¨±æœå°‹..." />
              <button type="button" id="clear-search" class="clear-search-btn" title="æ¸…é™¤æœå°‹">âœ•</button>
            </div>
          </div>
        </div>

        <div id="menu-container"></div>
      </div>

      <!-- è¨‚å–®ç®¡ç†å€åŸŸ -->
      <div class="section">
        <h2>ğŸ“‹ è¨‚å–®ç®¡ç†</h2>
        <input type="text" class="search-box" id="search-orders" placeholder="ğŸ” æœå°‹è€å¸«å§“åæˆ–é£²æ–™..." />

        <div class="total-section" id="total-section" style="display:none">
          <div>ç¸½è¨ˆé‡‘é¡</div>
          <div class="total-amount" id="total-amount">$0</div>
          <div id="order-count">å…± 0 æ¯é£²æ–™</div>
        </div>

        <div class="order-list" id="order-summary"></div>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn btn-success" id="download-csv" style="display:none">ğŸ“¥ ä¸‹è¼‰è¨‚å–® CSV</button>
          <button class="btn btn-danger" id="clear-all-orders" style="display:none">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
          <button class="btn btn-warning" id="admin-reset" style="display:none">ğŸ” ç®¡ç†å“¡é‡ç½®</button>
        </div>
      </div>
    </div>
  </div>

  <!-- èœå–®ç·¨è¼¯å½ˆå‡ºè¦–çª— -->
  <div id="menu-edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ ç·¨è¼¯èœå–®</h2>
        <button class="close-btn" onclick="closeMenuEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="edit-controls">
          <label for="edit-store-select">é¸æ“‡è¦ç·¨è¼¯çš„åº—å®¶ï¼š</label>
          <select id="edit-store-select">
            <option value="">è«‹é¸æ“‡åº—å®¶</option>
            <option value="milkshop">è¿·å®¢å¤ Milk Shop</option>
            <option value="50lan">50åµ</option>
            <option value="comebuy">æ¸…å¿ƒç¦å…¨</option>
            <option value="gongcha">è²¢èŒ¶</option>
            <option value="truedan">çç…®ä¸¹</option>
            <option value="songben">èŒ¶ä¹‹é­”æ‰‹</option>
            <option value="seventea">ä¸ƒç›èŒ¶</option>
            <option value="dejeng">å¾—æ­£</option>
            <option value="yimuday">ä¸€æ²æ—¥</option>
          </select>
          <button class="btn" onclick="addNewDrink()">â• æ–°å¢é£²æ–™</button>
        </div>

        <div id="menu-edit-list" class="menu-edit-list">
          <p>è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯çš„åº—å®¶</p>
        </div>

        <div class="modal-footer">
          <button class="btn" onclick="saveMenuChanges()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
          <button class="btn btn-secondary" onclick="closeMenuEditModal()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const menus = {
  milkshop: [
    // æ„›èŒ¶çš„ç‰›ç³»åˆ— (Læ¯) - å—éƒ¨åƒ¹æ ¼
    { name: "å¨œæ¯ç´…èŒ¶ (L)", price: 35 },
    { name: "è‹±å€«ä¼¯çˆµç´…èŒ¶ (L)", price: 30 },
    { name: "å¤§æ­£é†‡é¦™ç´…èŒ¶ (L)", price: 30 },
    { name: "åŸç‰‡åˆéœ²é’èŒ¶ (L)", price: 30 },
    { name: "ç¥ç€é«˜å³°çƒé¾ (L)", price: 30 },
    { name: "æ°´ä¹‹æ£®ç„ç±³æŠ¹èŒ¶ (L)", price: 45 },
    // ç‰§å ´é®®å¥¶èŒ¶ç³»åˆ— - å—éƒ¨åƒ¹æ ¼
    { name: "å¨œæ¯ç´…èŒ¶æ‹¿éµ (M)", price: 50 },
    { name: "å¨œæ¯ç´…èŒ¶æ‹¿éµ (L)", price: 60 },
    { name: "ä¼¯çˆµç´…èŒ¶æ‹¿éµ (M)", price: 45 },
    { name: "ä¼¯çˆµç´…èŒ¶æ‹¿éµ (L)", price: 55 },
    { name: "å¤§æ­£ç´…èŒ¶æ‹¿éµ (M)", price: 45 },
    { name: "å¤§æ­£ç´…èŒ¶æ‹¿éµ (L)", price: 55 },
    { name: "ç¥ç€çƒé¾æ‹¿éµ (M)", price: 45 },
    { name: "ç¥ç€çƒé¾æ‹¿éµ (L)", price: 55 },
    { name: "èŒ‰é¦™ç¶ èŒ¶æ‹¿éµ (M)", price: 45 },
    { name: "èŒ‰é¦™ç¶ èŒ¶æ‹¿éµ (L)", price: 55 },
    { name: "çç ç´…èŒ¶æ‹¿éµ (M)", price: 55 },
    { name: "çç ç´…èŒ¶æ‹¿éµ (L)", price: 65 },
    // ç¶ å…‰ç‰§å ´é®®å¥¶ç³»åˆ— (Mæ¯) - å—éƒ¨åƒ¹æ ¼
    { name: "èŠ‹é ­é®®å¥¶ (M)", price: 65 },
    { name: "æ‰‹ç‚’é»‘ç³–é®®å¥¶ (M)", price: 65 },
    { name: "æ³•èŠ™å¨œç´”å¯å¯é®®å¥¶ (M)", price: 65 },
    { name: "ç„ç±³æŠ¹èŒ¶æ‹¿éµ (M)", price: 65 },
    { name: "çç é®®å¥¶ (M)", price: 65 },
    { name: "å«©ä»™è‰å‡å¥¶ (M)", price: 65 },
    // æ‰‹ä½œç‰¹èª¿ç³»åˆ— (Læ¯) - å—éƒ¨åƒ¹æ ¼
    { name: "ç†Ÿé‡€é’æ¢…ç¶  (L)", price: 55 },
    { name: "èœœæ¡ƒçƒé¾ (L)", price: 65 },
    { name: "ç™½ç”˜è”—é’èŒ¶ (L)", price: 65 },
    { name: "å†¬ç“œé’èŒ¶ (L)", price: 50 },
    { name: "æŸ³ä¸ç¶ èŒ¶ (L)", price: 60 },
    { name: "é’æª¸é¦™èŒ¶ (L)", price: 65 },
    { name: "èœ‚èœœæª¸æª¬æ™¶å‡ (L)", price: 55 },
    { name: "é¤Šæ¨‚å¤šç¶  (L)", price: 50 }
  ],
  "50lan": [
    // æ‰¾å¥½èŒ¶ç³»åˆ— - å—éƒ¨åƒ¹æ ¼
    { name: "èŒ‰è‰ç¶ èŒ¶ (M)", price: 30 },
    { name: "èŒ‰è‰ç¶ èŒ¶ (L)", price: 35 },
    { name: "é˜¿è–©å§†ç´…èŒ¶ (M)", price: 30 },
    { name: "é˜¿è–©å§†ç´…èŒ¶ (L)", price: 35 },
    { name: "å››å­£æ˜¥é’èŒ¶ (M)", price: 30 },
    { name: "å››å­£æ˜¥é’èŒ¶ (L)", price: 35 },
    { name: "é»ƒé‡‘çƒé¾ (M)", price: 30 },
    { name: "é»ƒé‡‘çƒé¾ (L)", price: 35 },
    { name: "æª¸æª¬ç¶  (M)", price: 45 },
    { name: "æª¸æª¬ç¶  (L)", price: 50 },
    { name: "æ¢…ã®ç¶  (M)", price: 45 },
    { name: "æ¢…ã®ç¶  (L)", price: 50 },
    { name: "æ¡”å­ç¶  (M)", price: 45 },
    { name: "æ¡”å­ç¶  (L)", price: 50 },
    { name: "8å†°ç¶  (M)", price: 45 },
    { name: "8å†°ç¶  (L)", price: 50 },
    { name: "é¤Šæ¨‚å¤šç¶  (M)", price: 45 },
    { name: "é¤Šæ¨‚å¤šç¶  (L)", price: 50 },
    { name: "æ—ºä¾†ç´… (M)", price: 45 },
    { name: "æ—ºä¾†ç´… (L)", price: 50 },
    { name: "æŸšå­ç´… (M)", price: 45 },
    { name: "æŸšå­ç´… (L)", price: 50 },
    { name: "é®®æŸšç¶  (M)", price: 55 },
    { name: "é®®æŸšç¶  (L)", price: 60 },
    // æ‰¾å£æ„Ÿç³»åˆ— - å—éƒ¨åƒ¹æ ¼
    { name: "å››å­£æ˜¥+çæ³¢æ¤° (M)", price: 35 },
    { name: "å››å­£æ˜¥+çæ³¢æ¤° (L)", price: 40 },
    { name: "æ³¢éœ¸ç´…èŒ¶ (M)", price: 35 },
    { name: "æ³¢éœ¸ç´…èŒ¶ (L)", price: 40 },
    { name: "æ³¢éœ¸ç¶ èŒ¶ (M)", price: 35 },
    { name: "æ³¢éœ¸ç¶ èŒ¶ (L)", price: 40 },
    { name: "æ³¢éœ¸é’èŒ¶ (M)", price: 35 },
    { name: "æ³¢éœ¸é’èŒ¶ (L)", price: 40 },
    { name: "æ³¢éœ¸çƒé¾ (M)", price: 35 },
    { name: "æ³¢éœ¸çƒé¾ (L)", price: 40 },
    { name: "æ³¢éœ¸å¥¶èŒ¶ (M)", price: 45 },
    { name: "æ³¢éœ¸å¥¶èŒ¶ (L)", price: 50 },
    { name: "æ³¢éœ¸å¥¶ç¶  (M)", price: 45 },
    { name: "æ³¢éœ¸å¥¶ç¶  (L)", price: 50 },
    { name: "æ³¢éœ¸çƒé¾å¥¶èŒ¶ (M)", price: 45 },
    { name: "æ³¢éœ¸çƒé¾å¥¶èŒ¶ (L)", price: 50 },
    { name: "çç ç´…èŒ¶ (M)", price: 35 },
    { name: "çç ç´…èŒ¶ (L)", price: 40 },
    { name: "çç ç¶ èŒ¶ (M)", price: 35 },
    { name: "çç ç¶ èŒ¶ (L)", price: 40 },
    { name: "çç é’èŒ¶ (M)", price: 35 },
    { name: "çç é’èŒ¶ (L)", price: 40 },
    { name: "çç çƒé¾ (M)", price: 35 },
    { name: "çç çƒé¾ (L)", price: 40 },
    { name: "çç å¥¶èŒ¶ (M)", price: 45 },
    { name: "çç å¥¶èŒ¶ (L)", price: 50 },
    { name: "çç å¥¶ç¶  (M)", price: 45 },
    { name: "çç å¥¶ç¶  (L)", price: 50 },
    { name: "æ¤°æœå¥¶èŒ¶ (M)", price: 45 },
    { name: "æ¤°æœå¥¶èŒ¶ (L)", price: 50 },
    { name: "å¸ƒä¸å¥¶èŒ¶ (M)", price: 55 },
    { name: "å¸ƒä¸å¥¶èŒ¶ (L)", price: 60 },
    { name: "å¸ƒä¸å¥¶ç¶  (M)", price: 55 },
    { name: "å¸ƒä¸å¥¶ç¶  (L)", price: 60 },
    { name: "å¸ƒä¸ç´…èŒ¶ (M)", price: 45 },
    { name: "å¸ƒä¸ç´…èŒ¶ (L)", price: 50 },
    { name: "å¸ƒä¸ç¶ èŒ¶ (M)", price: 45 },
    { name: "å¸ƒä¸ç¶ èŒ¶ (L)", price: 50 },
    { name: "å¸ƒä¸é’èŒ¶", price: 50 },
    { name: "å¸ƒä¸çƒé¾", price: 50 },
    // æ‰¾å¥¶èŒ¶ç³»åˆ—
    { name: "å¥¶èŒ¶", price: 50 },
    { name: "å¥¶ç¶ ", price: 50 },
    { name: "ç´…èŒ¶ç‘ªå¥‡æœµ", price: 50 },
    { name: "çƒé¾ç‘ªå¥‡æœµ", price: 50 },
    { name: "å››å­£å¥¶é’", price: 50 },
    { name: "é»ƒé‡‘çƒé¾å¥¶èŒ¶", price: 50 },
    { name: "é˜¿è¯ç”°", price: 55 },
    // æ‰¾æ–°é®®ç³»åˆ—
    { name: "æª¸æª¬æ±", price: 55 },
    { name: "é‡‘æ¡”æª¸æª¬", price: 55 },
    { name: "æª¸æª¬æ¢…æ±", price: 60 },
    { name: "æª¸æª¬é¤Šæ¨‚å¤š", price: 65 },
    { name: "8å†°èŒ¶", price: 50 },
    { name: "æŸšå­èŒ¶", price: 50 },
    { name: "é®®æŸšæ±", price: 65 },
    { name: "è‘¡è„æŸšå¤šå¤š", price: 65 },
    // ç´…èŒ¶æ‹¿éµç³»åˆ—
    { name: "ç´…èŒ¶æ‹¿éµ", price: 60 },
    { name: "ç¶ èŒ¶æ‹¿éµ", price: 60 },
    { name: "é»ƒé‡‘çƒé¾æ‹¿éµ", price: 60 },
    { name: "é˜¿è¯ç”°æ‹¿éµ", price: 65 },
    // æ‰¾å†°æ·‡æ·‹ç³»åˆ—
    { name: "å†°æ·‡æ·‹ç´…èŒ¶", price: 50 },
    { name: "èŠ’æœé’", price: 50 },
    { name: "è”æçƒé¾", price: 50 }
  ],
  comebuy: [
    { name: "ç´…èŒ¶", price: 25 },
    { name: "ç¶ èŒ¶", price: 25 },
    { name: "çƒé¾èŒ¶", price: 30 },
    { name: "çç å¥¶èŒ¶", price: 40 },
    { name: "çç ç¶ èŒ¶", price: 40 },
    { name: "æª¸æª¬ç¶ èŒ¶", price: 35 },
    { name: "å†¬ç“œèŒ¶", price: 30 },
    { name: "èœ‚èœœæª¸æª¬", price: 40 },
    { name: "å¤šå¤šç¶ èŒ¶", price: 45 },
    { name: "å¸ƒä¸å¥¶èŒ¶", price: 50 }
  ],
  gongcha: [
    { name: "é˜¿é‡Œå±±çƒé¾èŒ¶", price: 35 },
    { name: "èŒ‰è‰ç¶ èŒ¶", price: 35 },
    { name: "å››å­£æ˜¥èŒ¶", price: 35 },
    { name: "çç å¥¶èŒ¶", price: 55 },
    { name: "çç ç¶ èŒ¶", price: 55 },
    { name: "å¸ƒä¸å¥¶èŒ¶", price: 60 },
    { name: "èŠ‹é ­å¥¶èŒ¶", price: 65 },
    { name: "é»‘ç³–çç å¥¶èŒ¶", price: 70 },
    { name: "æ‹›ç‰Œå¥¶èŒ¶", price: 60 },
    { name: "æª¸æª¬èœœèŒ¶", price: 50 }
  ],
  truedan: [
    // åŒ å¿ƒè·äººé»‘ç³–ç³»åˆ—
    { name: "é»‘ç³–çç é®®å¥¶ (M)", price: 55 },
    { name: "é»‘ç³–çç é®®å¥¶ (L)", price: 65 },
    { name: "é»‘ç³–ç²‰ç²¿é®®å¥¶ (M)", price: 55 },
    { name: "é»‘ç³–ç²‰ç²¿é®®å¥¶ (L)", price: 65 },
    { name: "é»‘ç³–çç åšé®®å¥¶ (M)", price: 65 },
    { name: "é»‘ç³–çç åšé®®å¥¶ (L)", price: 75 },
    { name: "æ‰‹ç†¬é»‘ç³–å†¬ç“œèŒ¶ (L)", price: 45 },
    // ç…®ä¸¹ç§æˆ¿å¥¶èŒ¶ç³»åˆ—
    { name: "æ³¢æ³¢ç²¿ç²¿é®®å¥¶èŒ¶ (M)", price: 60 },
    { name: "æ³¢æ³¢ç²¿ç²¿é®®å¥¶èŒ¶ (L)", price: 70 },
    { name: "çç å¥¶èŒ¶ (M)", price: 50 },
    { name: "çç å¥¶èŒ¶ (L)", price: 60 },
    { name: "å§å§ç´…èŒ¶æ‹¿éµ (M)", price: 45 },
    { name: "å§å§ç´…èŒ¶æ‹¿éµ (L)", price: 55 },
    { name: "æ³°æ³°é®®å¥¶èŒ¶ (M)", price: 50 },
    { name: "æ³°æ³°é®®å¥¶èŒ¶ (L)", price: 60 },
    { name: "ç…®æ¯å¥¶èŒ¶ (M)", price: 40 },
    { name: "ç…®æ¯å¥¶èŒ¶ (L)", price: 50 },
    // å³¶å¶¼æœèŒ¶ç³»åˆ— (Læ¯é™å®š)
    { name: "é’æª¸æ¡‚èŠ±é‡€ç²¿ç²¿ (L)", price: 65 },
    { name: "è¥¿ç“œçƒé¾ (L)", price: 60 },
    { name: "æ©™é¦™ç¿¡ç¿  (L)", price: 55 },
    { name: "å¤šå¤šæ˜¥ (L)", price: 55 },
    { name: "è‘¡æŸšç¿¡ç¿  (L)", price: 60 },
    { name: "èœ‚èœœæª¸æª¬èŠèŠ±èŒ¶ (L)", price: 50 },
    // ä¸–ç•ŒèŒ¶å…‰è­œç³»åˆ— (Læ¯)
    { name: "é›²éœ§çƒé¾ (L)", price: 45 },
    { name: "ä¸çŸ¥æ˜¥ (L)", price: 40 },
    { name: "å¾©åˆ»ç´…èŒ¶ (L)", price: 35 },
    { name: "è€æ´¾è•éº¥ (L)", price: 40 }
  ],
  songben: [
    // èŒ¶ä¹‹é­”æ‰‹ - å°ç£èŒ—èŒ¶ç³»åˆ—
    { name: "å°ç£é›ç´… (ä¸­)", price: 25 },
    { name: "å°ç£é›ç´… (å¤§)", price: 30 },
    { name: "å°ç£ç´”ç¶  (ä¸­)", price: 25 },
    { name: "å°ç£ç´”ç¶  (å¤§)", price: 30 },
    { name: "å°ç£é’èŒ¶ (ä¸­)", price: 25 },
    { name: "å°ç£é’èŒ¶ (å¤§)", price: 30 },
    { name: "å°ç£çƒé¾ (ä¸­)", price: 25 },
    { name: "å°ç£çƒé¾ (å¤§)", price: 30 },
    // ä¼¯çˆµç´…èŒ¶ç³»åˆ—
    { name: "ä¼¯çˆµç´…èŒ¶ (ä¸­)", price: 25 },
    { name: "ä¼¯çˆµç´…èŒ¶ (å¤§)", price: 30 },
    { name: "çç ä¼¯çˆµ (ä¸­)", price: 30 },
    { name: "çç ä¼¯çˆµ (å¤§)", price: 35 },
    { name: "ä¼¯çˆµå¥¶èŒ¶ (ä¸­)", price: 40 },
    { name: "ä¼¯çˆµå¥¶èŒ¶ (å¤§)", price: 45 },
    { name: "ä¼¯çˆµé®®å¥¶èŒ¶ (ä¸­)", price: 45 },
    { name: "ä¼¯çˆµé®®å¥¶èŒ¶ (å¤§)", price: 55 },
    // å¥¶èŒ¶ç³»åˆ—
    { name: "å¥¶èŒ¶ (ä¸­)", price: 40 },
    { name: "å¥¶èŒ¶ (å¤§)", price: 45 },
    { name: "é®®å¥¶èŒ¶ (ä¸­)", price: 45 },
    { name: "é®®å¥¶èŒ¶ (å¤§)", price: 55 },
    { name: "çç å¥¶èŒ¶ (ä¸­)", price: 45 },
    { name: "çç å¥¶èŒ¶ (å¤§)", price: 50 },
    { name: "æ³¢éœ¸å¥¶èŒ¶ (ä¸­)", price: 45 },
    { name: "æ³¢éœ¸å¥¶èŒ¶ (å¤§)", price: 50 },
    // ç‰¹èª¿ç³»åˆ—
    { name: "æª¸æª¬ç´…èŒ¶ (ä¸­)", price: 45 },
    { name: "æª¸æª¬ç´…èŒ¶ (å¤§)", price: 50 },
    { name: "å†¬ç“œèŒ¶ (ä¸­)", price: 25 },
    { name: "å†¬ç“œèŒ¶ (å¤§)", price: 30 },
    { name: "å¤šå¤šç¶ èŒ¶ (ä¸­)", price: 40 },
    { name: "å¤šå¤šç¶ èŒ¶ (å¤§)", price: 45 }
  ],
  seventea: [
    // ç¶“å…¸èŒ¶ç³»åˆ—
    { name: "å±±èƒçƒé¾", price: 40 },
    { name: "èŒ‰è‰ç¶ èŒ¶", price: 35 },
    { name: "é˜¿è–©å§†ç´…èŒ¶", price: 35 },
    { name: "å››å­£æ˜¥èŒ¶", price: 35 },
    // å¥¶éœœç³»åˆ—
    { name: "å±±èƒçƒé¾å¥¶éœœ", price: 65 },
    { name: "èŒ‰è‰ç¶ èŒ¶å¥¶éœœ", price: 60 },
    { name: "é˜¿è–©å§†å¥¶éœœ", price: 60 },
    // é®®å¥¶èŒ¶ç³»åˆ—
    { name: "çƒé¾é®®å¥¶èŒ¶", price: 55 },
    { name: "èŒ‰è‰é®®å¥¶èŒ¶", price: 50 },
    { name: "é˜¿è–©å§†é®®å¥¶èŒ¶", price: 50 },
    { name: "çç å¥¶èŒ¶", price: 55 },
    // ç‰¹èª¿ç³»åˆ—
    { name: "æª¸æª¬èœœèŒ¶", price: 45 },
    { name: "èœ‚èœœæŸšå­èŒ¶", price: 50 },
    { name: "å†¬ç“œæª¸æª¬", price: 40 },
    { name: "å¤šå¤šç¶ èŒ¶", price: 45 }
  ],
  dejeng: [
    // çƒé¾èŒ¶ç³»åˆ—
    { name: "å„ªé…ªæ˜¥çƒé¾", price: 55 },
    { name: "èŠå£«å¥¶è“‹ç„™çƒé¾", price: 65 },
    { name: "çƒ˜å‰é®®å¥¶", price: 60 },
    { name: "ç„™çƒé¾", price: 40 },
    { name: "æ˜¥çƒé¾", price: 35 },
    { name: "å‡é ‚çƒé¾", price: 45 },
    // ç‰¹èª¿ç³»åˆ—
    { name: "æª¸æª¬çƒé¾", price: 50 },
    { name: "èœ‚èœœçƒé¾", price: 45 },
    { name: "å†¬ç“œçƒé¾", price: 40 },
    { name: "æŸšå­çƒé¾", price: 50 },
    // é®®å¥¶ç³»åˆ—
    { name: "çƒé¾é®®å¥¶èŒ¶", price: 55 },
    { name: "ç„™çƒé¾é®®å¥¶", price: 60 },
    { name: "çç çƒé¾é®®å¥¶", price: 65 },
    { name: "å¸ƒä¸çƒé¾é®®å¥¶", price: 70 }
  ],
  yimuday: [
    // æ‹›ç‰Œç³»åˆ—
    { name: "ä¸€æ²æ—¥æ‹›ç‰Œå¥¶èŒ¶", price: 50 },
    { name: "é»‘ç³–çç é®®å¥¶", price: 60 },
    { name: "èŠ‹é ­é®®å¥¶", price: 65 },
    { name: "æŠ¹èŒ¶æ‹¿éµ", price: 70 },
    // èŒ¶é¡ç³»åˆ—
    { name: "ç´…èŒ¶", price: 30 },
    { name: "ç¶ èŒ¶", price: 30 },
    { name: "çƒé¾èŒ¶", price: 35 },
    { name: "èŒ‰è‰èŠ±èŒ¶", price: 35 },
    // é®®å¥¶èŒ¶ç³»åˆ—
    { name: "çç å¥¶èŒ¶", price: 55 },
    { name: "å¸ƒä¸å¥¶èŒ¶", price: 60 },
    { name: "æ¤°æœå¥¶èŒ¶", price: 55 },
    { name: "ä»™è‰å‡å¥¶èŒ¶", price: 55 },
    // ç‰¹èª¿ç³»åˆ—
    { name: "æª¸æª¬ç¶ èŒ¶", price: 45 },
    { name: "èœ‚èœœæª¸æª¬", price: 50 },
    { name: "å†¬ç“œèŒ¶", price: 35 },
    { name: "å¤šå¤šç¶ èŒ¶", price: 50 }
  ]
};

let currentMenu = [];
let orders = [];
let filteredOrders = [];
let editingOrderId = null;
let isOnlineMode = true; // æ˜¯å¦ä½¿ç”¨ç·šä¸Šæ¨¡å¼

// æª¢æŸ¥æ˜¯å¦ç‚ºç·šä¸Šæ¨¡å¼
function checkOnlineMode() {
  return window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
}

// API è«‹æ±‚å‡½æ•¸
async function apiRequest(url, options = {}) {
  try {
    const response = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error('API è«‹æ±‚éŒ¯èª¤:', error);
    // å¦‚æœ API å¤±æ•—ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å„²
    if (isOnlineMode) {
      console.log('å›é€€åˆ°æœ¬åœ°å­˜å„²æ¨¡å¼');
      isOnlineMode = false;
    }
    throw error;
  }
}

// è¼‰å…¥è¨‚å–®ï¼ˆç·šä¸Šæ¨¡å¼æˆ–æœ¬åœ°æ¨¡å¼ï¼‰
async function loadOrders() {
  isOnlineMode = checkOnlineMode();

  if (isOnlineMode) {
    try {
      const data = await apiRequest('/api/orders');
      orders = data.orders || [];
      filteredOrders = [...orders];
      updateOrderSummary(data.totalAmount || 0, data.totalCount || 0);
      showOrders();
      console.log('âœ… å¾ä¼ºæœå™¨è¼‰å…¥è¨‚å–®:', orders.length, 'ç­†');
      return;
    } catch (error) {
      console.log('âš ï¸ ç„¡æ³•å¾ä¼ºæœå™¨è¼‰å…¥è¨‚å–®ï¼Œä½¿ç”¨æœ¬åœ°å­˜å„²');
      isOnlineMode = false;
    }
  }

  // æœ¬åœ°å­˜å„²æ¨¡å¼
  const saved = localStorage.getItem('drinkOrders');
  if (saved) {
    orders = JSON.parse(saved);
    filteredOrders = [...orders];
    showOrders();
    console.log('ğŸ“± å¾æœ¬åœ°å­˜å„²è¼‰å…¥è¨‚å–®:', orders.length, 'ç­†');
  }
}

// å„²å­˜è¨‚å–®ï¼ˆç·šä¸Šæ¨¡å¼æˆ–æœ¬åœ°æ¨¡å¼ï¼‰
async function saveOrders() {
  if (isOnlineMode) {
    // ç·šä¸Šæ¨¡å¼ä¸éœ€è¦æ‰‹å‹•å„²å­˜ï¼ŒAPI æœƒè‡ªå‹•è™•ç†
    return true;
  } else {
    // æœ¬åœ°å­˜å„²æ¨¡å¼
    localStorage.setItem('drinkOrders', JSON.stringify(orders));
    return true;
  }
}

// æ›´æ–°è¨‚å–®çµ±è¨ˆ
function updateOrderSummary(totalAmount, totalCount) {
  document.getElementById('total-amount').textContent = `$${totalAmount}`;
  document.getElementById('order-count').textContent = `å…± ${totalCount} æ¯é£²æ–™`;
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
  console.log('ğŸš€ é£²æ–™é»é¤ç³»çµ±åˆå§‹åŒ–ä¸­...');

  // æª¢æŸ¥é‹è¡Œæ¨¡å¼
  isOnlineMode = checkOnlineMode();
  console.log('ğŸŒ é‹è¡Œæ¨¡å¼:', isOnlineMode ? 'ç·šä¸Šæ¨¡å¼' : 'æœ¬åœ°æ¨¡å¼');

  // è¼‰å…¥è¨‚å–®
  await loadOrders();

  // é¡¯ç¤ºæ¨¡å¼è³‡è¨Š
  const modeInfo = document.createElement('div');
  modeInfo.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 1000;';
  modeInfo.textContent = isOnlineMode ? 'ğŸŒ ç·šä¸Šå”ä½œæ¨¡å¼' : 'ğŸ“± æœ¬åœ°æ¨¡å¼';
  document.body.appendChild(modeInfo);

  console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
});

document.getElementById('store-select').addEventListener('change', function() {
  const store = this.value;
  if (!store) {
    document.getElementById('menu-section').style.display = 'none';
    return;
  }

  if (store === 'custom') {
    document.getElementById('menu-upload').click();
    return;
  }

  currentMenu = menus[store] || [];
  showMenu(currentMenu);
});

document.getElementById('upload-menu-btn').onclick = () => {
  document.getElementById('menu-upload').click();
};

document.getElementById('menu-upload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      if (results.data && results.data.length > 0) {
        // å–å¾—åº—å®¶åç¨±ï¼ˆå¾ç¬¬ä¸€ç­†è³‡æ–™ä¸­è®€å–ï¼‰
        const firstItem = results.data[0];
        const storeName = firstItem.store || firstItem['é£²æ–™åº—åç¨±'] || firstItem['åº—å®¶åç¨±'] || 'è‡ªè¨‚èœå–®';

        // ç¢ºä¿è³‡æ–™æ ¼å¼æ­£ç¢º
        currentMenu = results.data.map(item => ({
          name: item.name || item['é£²æ–™åç¨±'] || '',
          price: parseInt(item.price || item['åƒ¹æ ¼'] || 0)
        })).filter(item => item.name && item.price);

        if (currentMenu.length > 0) {
          // æ›´æ–°èœå–®æ¨™é¡Œé¡¯ç¤ºåº—å®¶åç¨±
          const menuTitle = document.querySelector('#menu-section h2');
          if (menuTitle) {
            menuTitle.textContent = `ğŸ¹ ${storeName} èœå–®`;
          }

          showMenu(currentMenu);
          alert(`æˆåŠŸè¼‰å…¥ ${storeName} çš„ ${currentMenu.length} é …é£²æ–™ï¼`);
        } else {
          alert('CSV æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¢ºä¿åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š\n- é£²æ–™åº—åç¨± (store)\n- é£²æ–™åç¨± (name)\n- åƒ¹æ ¼ (price)');
        }
      }
    },
    error: function(error) {
      alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
    }
  });
});

// æœå°‹åŠŸèƒ½
document.getElementById('search-orders').addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  if (!searchTerm) {
    filteredOrders = [...orders];
  } else {
    filteredOrders = orders.filter(order =>
      order.teacher.toLowerCase().includes(searchTerm) ||
      order.drink.toLowerCase().includes(searchTerm)
    );
  }
  showOrders();
});

// æ¸…ç©ºæ‰€æœ‰è¨‚å–®
document.getElementById('clear-all-orders').addEventListener('click', async function() {
  if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
    if (isOnlineMode) {
      // ç·šä¸Šæ¨¡å¼ä½¿ç”¨æœ¬åœ°æ¸…ç©ºï¼ˆä¸éœ€è¦å¯†ç¢¼ï¼‰
      orders = [];
      filteredOrders = [];
      await saveOrders();
      showOrders();
    } else {
      // æœ¬åœ°æ¨¡å¼
      orders = [];
      filteredOrders = [];
      await saveOrders();
      showOrders();
    }
  }
});

// ç®¡ç†å“¡é‡ç½®åŠŸèƒ½
document.getElementById('admin-reset').addEventListener('click', async function() {
  const password = prompt('è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š');

  if (!password) {
    return;
  }

  if (password !== '0718') {
    alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼');
    return;
  }

  if (!confirm('âš ï¸ ç®¡ç†å“¡é‡ç½®å°‡æ¸…ç©ºæ‰€æœ‰è¨‚å–®è³‡æ–™ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
    return;
  }

  try {
    if (isOnlineMode) {
      // ç·šä¸Šæ¨¡å¼ï¼šä½¿ç”¨ API é‡ç½®
      const result = await apiRequest('/api/admin/reset', {
        method: 'POST',
        body: JSON.stringify({ password: password })
      });

      if (result.success) {
        await loadOrders(); // é‡æ–°è¼‰å…¥è¨‚å–®
        alert('âœ… ç®¡ç†å“¡é‡ç½®æˆåŠŸï¼æ‰€æœ‰è¨‚å–®å·²æ¸…ç©ºã€‚');
      } else {
        throw new Error(result.message || 'é‡ç½®å¤±æ•—');
      }
    } else {
      // æœ¬åœ°æ¨¡å¼
      orders = [];
      filteredOrders = [];
      await saveOrders();
      showOrders();
      alert('âœ… ç®¡ç†å“¡é‡ç½®æˆåŠŸï¼æ‰€æœ‰è¨‚å–®å·²æ¸…ç©ºã€‚');
    }
  } catch (error) {
    console.error('ç®¡ç†å“¡é‡ç½®éŒ¯èª¤:', error);
    alert('âŒ é‡ç½®å¤±æ•—ï¼š' + error.message);
  }
});

// ä¸‹è¼‰èœå–®ç¯„æœ¬ä¸‹æ‹‰é¸å–®
document.getElementById('download-menu-btn').addEventListener('click', function(e) {
  e.stopPropagation();
  const dropdown = document.getElementById('download-menu-dropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
});

// é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ä¸‹æ‹‰é¸å–®
document.addEventListener('click', function() {
  document.getElementById('download-menu-dropdown').style.display = 'none';
});

// ç·¨è¼¯èœå–®æŒ‰éˆ•äº‹ä»¶
document.getElementById('edit-menu-btn').addEventListener('click', function() {
  document.getElementById('menu-edit-modal').style.display = 'flex';
});

// ç·¨è¼¯åº—å®¶é¸æ“‡äº‹ä»¶
document.getElementById('edit-store-select').addEventListener('change', function() {
  const store = this.value;
  if (!store) {
    document.getElementById('menu-edit-list').innerHTML = '<p>è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯çš„åº—å®¶</p>';
    return;
  }

  showEditMenu(store);
});

let currentEditStore = '';
let editingMenu = [];

function showMenu(menu) {
  if (!menu || menu.length === 0) {
    document.getElementById('menu-section').style.display = 'none';
    return;
  }

  document.getElementById('menu-section').style.display = 'block';
  const container = document.getElementById('menu-container');

  // ç²å–ç•¶å‰é¸æ“‡çš„åº—å®¶åç¨±
  const storeSelect = document.getElementById('store-select');
  const currentStoreName = storeSelect.options[storeSelect.selectedIndex].text;

  let html = '<div class="menu-items-container">';

  menu.forEach((item, idx) => {
    html += `<div class="menu-item-card" data-idx="${idx}">
      <div class="drink-header">
        <h3 class="drink-name">${item.name}</h3>
        <span class="drink-price">$${item.price}</span>
      </div>

      <div class="drink-options">
        <div class="option-row">
          <div class="option-group">
            <label>ğŸ”¢ æ•¸é‡ï¼š</label>
            <select class="quantity-select" data-idx="${idx}">
              <option value="1">1æ¯</option>
              <option value="2">2æ¯</option>
              <option value="3">3æ¯</option>
              <option value="4">4æ¯</option>
              <option value="5">5æ¯</option>
              <option value="6">6æ¯</option>
              <option value="7">7æ¯</option>
              <option value="8">8æ¯</option>
              <option value="9">9æ¯</option>
              <option value="10">10æ¯</option>
            </select>
          </div>
        </div>

        <div class="option-row">
          <div class="option-group">
            <label>ğŸ¯ ç³–åº¦ï¼š</label>
            <select class="sugar-select" data-idx="${idx}">
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="å°‘ç³–">å°‘ç³–</option>
              <option value="åŠç³–">åŠç³–</option>
              <option value="å¾®ç³–">å¾®ç³–</option>
              <option value="ç„¡ç³–">ç„¡ç³–</option>
            </select>
          </div>
          <div class="option-group">
            <label>ğŸ§Š å†°å¡Šï¼š</label>
            <select class="ice-select" data-idx="${idx}">
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="å°‘å†°">å°‘å†°</option>
              <option value="å¾®å†°">å¾®å†°</option>
              <option value="å»å†°">å»å†°</option>
              <option value="ç†±">ç†±</option>
            </select>
          </div>
        </div>
      </div>

      <div class="add-order-section">
        <button type="button" class="btn btn-success add-order-btn"
                onclick="addSingleOrder(${idx}, '${item.name}', ${item.price}, '${currentStoreName}')"
                data-idx="${idx}">
          âœ… åŠ å…¥è¨‚å–®
        </button>
      </div>
    </div>`;
  });

  html += '</div>';
  container.innerHTML = html;

  // åŠ å…¥æœå°‹åŠŸèƒ½
  setupDrinkSearch();
}

// è¨­ç½®é£²æ–™æœå°‹åŠŸèƒ½
function setupDrinkSearch() {
  const searchInput = document.getElementById('drink-search');
  const clearBtn = document.getElementById('clear-search');
  if (!searchInput) return;

  // æœå°‹åŠŸèƒ½
  function performSearch() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const menuCards = document.querySelectorAll('.menu-item-card');
    let visibleCount = 0;

    menuCards.forEach(card => {
      const drinkName = card.querySelector('.drink-name').textContent.toLowerCase();
      if (drinkName.includes(searchTerm)) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // é¡¯ç¤º/éš±è—æ¸…é™¤æŒ‰éˆ•
    if (clearBtn) {
      clearBtn.style.display = searchTerm ? 'flex' : 'none';
    }

    // å¦‚æœæœå°‹æ¡†ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰é£²æ–™
    if (searchTerm === '') {
      menuCards.forEach(card => {
        card.style.display = 'block';
      });
    }

    // é¡¯ç¤ºæœå°‹çµæœæ•¸é‡ï¼ˆå¯é¸ï¼‰
    console.log(`æœå°‹ "${searchTerm}" æ‰¾åˆ° ${visibleCount} å€‹çµæœ`);
  }

  // ç¶å®šæœå°‹äº‹ä»¶
  searchInput.addEventListener('input', performSearch);

  // ç¶å®šæ¸…é™¤æŒ‰éˆ•äº‹ä»¶
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      searchInput.value = '';
      performSearch();
      searchInput.focus();
    });
  }

  // åˆå§‹åŒ–æ¸…é™¤æŒ‰éˆ•ç‹€æ…‹
  if (clearBtn) {
    clearBtn.style.display = 'none';
  }
}

// æ–°å¢å–®å€‹é£²æ–™è¨‚å–®çš„å‡½æ•¸
async function addSingleOrder(idx, drinkName, price, storeName) {
  const globalTeacherInput = document.getElementById('global-teacher-name');
  const quantitySelect = document.querySelector(`.quantity-select[data-idx="${idx}"]`);
  const sugarSelect = document.querySelector(`.sugar-select[data-idx="${idx}"]`);
  const iceSelect = document.querySelector(`.ice-select[data-idx="${idx}"]`);

  const teacher = globalTeacherInput.value.trim();
  const quantity = parseInt(quantitySelect.value);
  const sugar = sugarSelect.value;
  const ice = iceSelect.value;

  if (!teacher) {
    alert('è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥è€å¸«å§“åï¼');
    globalTeacherInput.focus();
    return;
  }

  try {
    // æ ¹æ“šæ•¸é‡å‰µå»ºå¤šç­†è¨‚å–®
    for (let i = 0; i < quantity; i++) {
      const newOrder = {
        teacher,
        drink: drinkName,
        sugar,
        ice,
        price,
        store: storeName, // æ–°å¢åº—å®¶åç¨±
        quantity: 1, // æ¯ç­†è¨‚å–®éƒ½æ˜¯1æ¯
        timestamp: new Date().toLocaleString('zh-TW')
      };

      if (isOnlineMode) {
        // ç·šä¸Šæ¨¡å¼ï¼šä½¿ç”¨ API
        const result = await apiRequest('/api/orders', {
          method: 'POST',
          body: JSON.stringify(newOrder)
        });

        if (!result.success) {
          throw new Error(result.message || 'æ–°å¢è¨‚å–®å¤±æ•—');
        }
      } else {
        // æœ¬åœ°æ¨¡å¼
        newOrder.id = Date.now().toString() + '_' + i; // ç¢ºä¿æ¯ç­†è¨‚å–®æœ‰å”¯ä¸€ID
        orders.push(newOrder);
      }
    }

    if (!isOnlineMode) {
      filteredOrders = [...orders];
      await saveOrders();
      showOrders();
    } else {
      // ç·šä¸Šæ¨¡å¼é‡æ–°è¼‰å…¥æ‰€æœ‰è¨‚å–®
      await loadOrders();
    }

    // æ¸…ç©ºè¼¸å…¥ï¼ˆä¸æ¸…ç©ºè€å¸«å§“åï¼Œå› ç‚ºæ˜¯å…¨åŸŸçš„ï¼‰
    quantitySelect.value = '1';
    sugarSelect.value = 'æ­£å¸¸';
    iceSelect.value = 'æ­£å¸¸';

    // æˆåŠŸæç¤º
    const quantityText = quantity > 1 ? `${quantity}æ¯` : '1æ¯';
    alert(`âœ… å·²ç‚º ${teacher} è€å¸«åŠ å…¥è¨‚å–®ï¼š${quantityText} ${drinkName} (${storeName})`);

  } catch (error) {
    console.error('æ–°å¢è¨‚å–®éŒ¯èª¤:', error);
    alert('âŒ æ–°å¢è¨‚å–®å¤±æ•—ï¼š' + error.message);
  }
}

// ç§»é™¤èˆŠçš„è¡¨å–®æäº¤è™•ç†ï¼ˆå› ç‚ºç¾åœ¨ä¸éœ€è¦äº†ï¼‰



function showOrders() {
  const container = document.getElementById('order-summary');
  const totalSection = document.getElementById('total-section');
  const downloadBtn = document.getElementById('download-csv');
  const clearBtn = document.getElementById('clear-all-orders');
  const adminBtn = document.getElementById('admin-reset');

  if (orders.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ğŸ“ é‚„æ²’æœ‰ä»»ä½•è¨‚å–®ï¼Œé–‹å§‹é»é¤å§ï¼</p>';
    totalSection.style.display = 'none';
    downloadBtn.style.display = 'none';
    clearBtn.style.display = 'none';
    adminBtn.style.display = 'none';
    return;
  }

  // è¨ˆç®—ç¸½è¨ˆ
  const totalAmount = orders.reduce((sum, order) => sum + (order.price || 0), 0);
  const totalCount = orders.length;

  // é¡¯ç¤ºç¸½è¨ˆ
  document.getElementById('total-amount').textContent = `$${totalAmount}`;
  document.getElementById('order-count').textContent = `å…± ${totalCount} æ¯é£²æ–™`;
  totalSection.style.display = 'block';

  // é¡¯ç¤ºè¨‚å–®è¡¨æ ¼
  let html = '<table>';
  html += '<tr><th>ğŸ‘¨â€ğŸ« è€å¸«</th><th>ğŸª åº—å®¶</th><th>ğŸ¹ é£²æ–™</th><th>ğŸ¯ ç³–åº¦</th><th>ğŸ§Š å†°å¡Š</th><th>ğŸ’° åƒ¹æ ¼</th><th>â° æ™‚é–“</th><th>ğŸ› ï¸ æ“ä½œ</th></tr>';

  const ordersToShow = filteredOrders.length > 0 ? filteredOrders : orders;
  ordersToShow.forEach((order, index) => {
    const storeName = order.store || 'æœªçŸ¥åº—å®¶';
    html += `<tr>
      <td>${order.teacher}</td>
      <td><span class="store-badge">${storeName}</span></td>
      <td>${order.drink}</td>
      <td>${order.sugar}</td>
      <td>${order.ice}</td>
      <td>$${order.price || 0}</td>
      <td>${order.timestamp || ''}</td>
      <td class="order-actions">
        <button class="btn btn-danger" onclick="deleteOrder('${order.id}')" title="åˆªé™¤è¨‚å–®">ğŸ—‘ï¸</button>
        <button class="btn" onclick="editOrder('${order.id}')" title="ç·¨è¼¯è¨‚å–®">âœï¸</button>
      </td>
    </tr>`;
  });

  html += '</table>';
  container.innerHTML = html;

  downloadBtn.style.display = 'inline-block';
  clearBtn.style.display = 'inline-block';
  adminBtn.style.display = 'inline-block';
}

// åˆªé™¤è¨‚å–®
async function deleteOrder(orderId) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) {
    return;
  }

  try {
    if (isOnlineMode) {
      // ç·šä¸Šæ¨¡å¼ï¼šä½¿ç”¨ API
      const result = await apiRequest(`/api/orders/${orderId}`, {
        method: 'DELETE'
      });

      if (result.success) {
        await loadOrders(); // é‡æ–°è¼‰å…¥è¨‚å–®
      } else {
        throw new Error(result.message || 'åˆªé™¤è¨‚å–®å¤±æ•—');
      }
    } else {
      // æœ¬åœ°æ¨¡å¼
      orders = orders.filter(order => order.id != orderId);
      filteredOrders = filteredOrders.filter(order => order.id != orderId);
      await saveOrders();
      showOrders();
    }
  } catch (error) {
    console.error('åˆªé™¤è¨‚å–®éŒ¯èª¤:', error);
    alert('âŒ åˆªé™¤è¨‚å–®å¤±æ•—ï¼š' + error.message);
  }
}

// ç·¨è¼¯è¨‚å–®
function editOrder(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  // å‰µå»ºç·¨è¼¯å°è©±æ¡†
  const editModal = document.createElement('div');
  editModal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;

  editModal.innerHTML = `
    <div style="
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    ">
      <h3 style="margin-top: 0; color: #333; text-align: center;">âœï¸ ç·¨è¼¯è¨‚å–®</h3>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ‘¨â€ğŸ« è€å¸«å§“åï¼š</label>
        <input type="text" id="edit-teacher" value="${order.teacher}" style="
          width: 100%;
          padding: 10px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
        ">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ¹ é£²æ–™åç¨±ï¼š</label>
        <input type="text" id="edit-drink" value="${order.drink}" style="
          width: 100%;
          padding: 10px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
        ">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ¯ ç³–åº¦ï¼š</label>
        <select id="edit-sugar" style="
          width: 100%;
          padding: 10px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
        ">
          <option value="æ­£å¸¸" ${order.sugar === 'æ­£å¸¸' ? 'selected' : ''}>æ­£å¸¸</option>
          <option value="å°‘ç³–" ${order.sugar === 'å°‘ç³–' ? 'selected' : ''}>å°‘ç³–</option>
          <option value="åŠç³–" ${order.sugar === 'åŠç³–' ? 'selected' : ''}>åŠç³–</option>
          <option value="å¾®ç³–" ${order.sugar === 'å¾®ç³–' ? 'selected' : ''}>å¾®ç³–</option>
          <option value="ç„¡ç³–" ${order.sugar === 'ç„¡ç³–' ? 'selected' : ''}>ç„¡ç³–</option>
        </select>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ§Š å†°å¡Šï¼š</label>
        <select id="edit-ice" style="
          width: 100%;
          padding: 10px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
        ">
          <option value="æ­£å¸¸" ${order.ice === 'æ­£å¸¸' ? 'selected' : ''}>æ­£å¸¸</option>
          <option value="å°‘å†°" ${order.ice === 'å°‘å†°' ? 'selected' : ''}>å°‘å†°</option>
          <option value="å¾®å†°" ${order.ice === 'å¾®å†°' ? 'selected' : ''}>å¾®å†°</option>
          <option value="å»å†°" ${order.ice === 'å»å†°' ? 'selected' : ''}>å»å†°</option>
          <option value="ç†±" ${order.ice === 'ç†±' ? 'selected' : ''}>ç†±</option>
        </select>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ’° åƒ¹æ ¼ï¼š</label>
        <input type="number" id="edit-price" value="${order.price || 0}" min="0" style="
          width: 100%;
          padding: 10px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
        ">
      </div>

      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="save-edit" style="
          background: #28a745;
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">âœ… å„²å­˜</button>
        <button id="cancel-edit" style="
          background: #6c757d;
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  `;

  document.body.appendChild(editModal);

  // å„²å­˜æŒ‰éˆ•äº‹ä»¶
  document.getElementById('save-edit').onclick = async function() {
    const newTeacher = document.getElementById('edit-teacher').value.trim();
    const newDrink = document.getElementById('edit-drink').value.trim();
    const newSugar = document.getElementById('edit-sugar').value;
    const newIce = document.getElementById('edit-ice').value;
    const newPrice = parseInt(document.getElementById('edit-price').value) || 0;

    if (!newTeacher || !newDrink) {
      alert('è«‹å¡«å¯«è€å¸«å§“åå’Œé£²æ–™åç¨±ï¼');
      return;
    }

    try {
      // æ›´æ–°è¨‚å–®è³‡æ–™
      order.teacher = newTeacher;
      order.drink = newDrink;
      order.sugar = newSugar;
      order.ice = newIce;
      order.price = newPrice;
      order.timestamp = new Date().toLocaleString('zh-TW') + ' (å·²ç·¨è¼¯)';

      // æ›´æ–° filteredOrders ä¸­çš„å°æ‡‰é …ç›®
      const filteredIndex = filteredOrders.findIndex(o => o.id === orderId);
      if (filteredIndex !== -1) {
        filteredOrders[filteredIndex] = { ...order };
      }

      if (isOnlineMode) {
        // ç·šä¸Šæ¨¡å¼ï¼šä½¿ç”¨ API
        const result = await apiRequest(`/api/orders/${orderId}`, {
          method: 'PUT',
          body: JSON.stringify(order)
        });

        if (!result.success) {
          throw new Error(result.message || 'æ›´æ–°è¨‚å–®å¤±æ•—');
        }

        await loadOrders();
      } else {
        // æœ¬åœ°æ¨¡å¼
        await saveOrders();
        showOrders();
      }

      document.body.removeChild(editModal);
      alert('âœ… è¨‚å–®å·²æˆåŠŸæ›´æ–°ï¼');
    } catch (error) {
      console.error('æ›´æ–°è¨‚å–®éŒ¯èª¤:', error);
      alert('âŒ æ›´æ–°è¨‚å–®å¤±æ•—ï¼š' + error.message);
    }
  };

  // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
  document.getElementById('cancel-edit').onclick = function() {
    document.body.removeChild(editModal);
  };

  // é»æ“ŠèƒŒæ™¯é—œé–‰
  editModal.onclick = function(e) {
    if (e.target === editModal) {
      document.body.removeChild(editModal);
    }
  };
}

// ä¸‹è¼‰ CSV åŠŸèƒ½
function downloadOrdersCSV() {
  if (orders.length === 0) {
    alert('æ²’æœ‰è¨‚å–®å¯ä»¥ä¸‹è¼‰ï¼');
    return;
  }

  try {
    // æº–å‚™ CSV è³‡æ–™
    const csvData = orders.map(order => ({
      'è€å¸«å§“å': order.teacher || '',
      'åº—å®¶åç¨±': order.store || 'æœªçŸ¥åº—å®¶',
      'é£²æ–™åç¨±': order.drink || '',
      'ç³–åº¦': order.sugar || '',
      'å†°å¡Š': order.ice || '',
      'åƒ¹æ ¼': order.price || 0,
      'è¨‚è³¼æ™‚é–“': order.timestamp || ''
    }));

    // æ·»åŠ ç¸½è¨ˆè¡Œ
    const totalAmount = orders.reduce((sum, order) => sum + (order.price || 0), 0);
    csvData.push({
      'è€å¸«å§“å': 'ç¸½è¨ˆ',
      'åº—å®¶åç¨±': '',
      'é£²æ–™åç¨±': `${orders.length} æ¯`,
      'ç³–åº¦': '',
      'å†°å¡Š': '',
      'åƒ¹æ ¼': totalAmount,
      'è¨‚è³¼æ™‚é–“': new Date().toLocaleString('zh-TW')
    });

    // æª¢æŸ¥ Papa Parse æ˜¯å¦å¯ç”¨
    if (typeof Papa === 'undefined') {
      // å¦‚æœ Papa Parse ä¸å¯ç”¨ï¼Œä½¿ç”¨ç°¡å–®çš„ CSV ç”Ÿæˆ
      let csvContent = 'è€å¸«å§“å,åº—å®¶åç¨±,é£²æ–™åç¨±,ç³–åº¦,å†°å¡Š,åƒ¹æ ¼,è¨‚è³¼æ™‚é–“\n';
      csvData.forEach(row => {
        csvContent += `"${row['è€å¸«å§“å']}","${row['åº—å®¶åç¨±']}","${row['é£²æ–™åç¨±']}","${row['ç³–åº¦']}","${row['å†°å¡Š']}","${row['åƒ¹æ ¼']}","${row['è¨‚è³¼æ™‚é–“']}"\n`;
      });
      var csv = csvContent;
    } else {
      var csv = Papa.unparse(csvData);
    }

    // æ·»åŠ  BOM ä»¥æ”¯æ´ä¸­æ–‡
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], {type: "text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    // ç”Ÿæˆæª”æ¡ˆåç¨±
    const now = new Date();
    const dateStr = now.toISOString().slice(0, 10);
    const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
    a.download = `é£²æ–™è¨‚å–®_${dateStr}_${timeStr}.csv`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert(`âœ… è¨‚å–®å·²ä¸‹è¼‰ï¼å…± ${orders.length} ç­†è¨‚å–®ï¼Œç¸½é‡‘é¡ $${totalAmount}`);
  } catch (error) {
    console.error('ä¸‹è¼‰ CSV éŒ¯èª¤:', error);
    alert('âŒ ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
  }
}

// ç¶å®šä¸‹è¼‰æŒ‰éˆ•äº‹ä»¶
document.getElementById('download-csv').onclick = downloadOrdersCSV;

// ä¸‹è¼‰èœå–®ç¯„æœ¬åŠŸèƒ½
function downloadMenuTemplate(format) {
  // é—œé–‰ä¸‹æ‹‰é¸å–®
  document.getElementById('download-menu-dropdown').style.display = 'none';

  // æº–å‚™ç¯„æœ¬è³‡æ–™
  const templateData = [
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "ç´…èŒ¶", price: 30 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "ç¶ èŒ¶", price: 30 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "çƒé¾èŒ¶", price: 35 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "çç å¥¶èŒ¶", price: 50 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "çç ç¶ èŒ¶", price: 50 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "å¸ƒä¸å¥¶èŒ¶", price: 55 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "æ¤°æœå¥¶èŒ¶", price: 50 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "ä»™è‰å‡å¥¶èŒ¶", price: 55 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "èŠ‹é ­å¥¶èŒ¶", price: 60 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "æŠ¹èŒ¶æ‹¿éµ", price: 65 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "æª¸æª¬ç¶ èŒ¶", price: 40 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "èœ‚èœœæª¸æª¬", price: 45 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "å†¬ç“œèŒ¶", price: 35 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "é’è‰èŒ¶", price: 35 },
    { store: "ç¯„ä¾‹é£²æ–™åº—", name: "å¤šå¤šç¶ èŒ¶", price: 45 }
  ];

  const now = new Date();
  const dateStr = now.toISOString().slice(0, 10);
  const timeStr = now.toTimeString().slice(0, 5).replace(':', '');

  let content, mimeType, extension, filename;

  switch(format) {
    case 'csv':
      // CSV æ ¼å¼
      content = 'é£²æ–™åº—åç¨±,é£²æ–™åç¨±,åƒ¹æ ¼\n' + templateData.map(item => `${item.store},${item.name},${item.price}`).join('\n');
      content = '\uFEFF' + content; // æ·»åŠ  BOM æ”¯æ´ä¸­æ–‡
      mimeType = 'text/csv;charset=utf-8';
      extension = 'csv';
      break;

    case 'excel':
      // Excel ç›¸å®¹çš„ CSV æ ¼å¼
      content = 'é£²æ–™åº—åç¨±,é£²æ–™åç¨±,åƒ¹æ ¼\n' + templateData.map(item => `"${item.store}","${item.name}",${item.price}`).join('\n');
      content = '\uFEFF' + content; // æ·»åŠ  BOM æ”¯æ´ä¸­æ–‡
      mimeType = 'application/vnd.ms-excel;charset=utf-8';
      extension = 'csv';
      break;

    case 'json':
      // JSON æ ¼å¼
      content = JSON.stringify({
        "èªªæ˜": "é£²æ–™èœå–®ç¯„æœ¬ - è«‹ä¿®æ”¹ storeã€name å’Œ price æ¬„ä½",
        "æ ¼å¼": "æ¯å€‹é£²æ–™é …ç›®éœ€åŒ…å« storeï¼ˆé£²æ–™åº—åç¨±ï¼‰ã€nameï¼ˆé£²æ–™åç¨±ï¼‰å’Œ priceï¼ˆåƒ¹æ ¼ï¼‰",
        "æ¬„ä½èªªæ˜": {
          "store": "é£²æ–™åº—åç¨±ï¼ˆå¿…å¡«ï¼‰",
          "name": "é£²æ–™åç¨±ï¼ˆå¿…å¡«ï¼‰",
          "price": "åƒ¹æ ¼ï¼ˆå¿…å¡«ï¼Œæ•¸å­—ï¼‰"
        },
        "ç¯„ä¾‹": templateData,
        "èœå–®": templateData
      }, null, 2);
      mimeType = 'application/json;charset=utf-8';
      extension = 'json';
      break;

    case 'txt':
      // æ–‡å­—æ ¼å¼
      content = 'é£²æ–™èœå–®ç¯„æœ¬\n';
      content += '='.repeat(20) + '\n\n';
      content += 'æ ¼å¼èªªæ˜ï¼š\n';
      content += '- æ¯è¡Œä¸€å€‹é£²æ–™é …ç›®\n';
      content += '- æ ¼å¼ï¼šé£²æ–™åº—åç¨±,é£²æ–™åç¨±,åƒ¹æ ¼\n';
      content += '- è«‹å°‡æ­¤æª”æ¡ˆè½‰æ›ç‚º CSV æ ¼å¼å¾Œä¸Šå‚³\n\n';
      content += 'æ¬„ä½èªªæ˜ï¼š\n';
      content += '- é£²æ–™åº—åç¨±ï¼šæ‚¨çš„é£²æ–™åº—åç¨±ï¼ˆå¿…å¡«ï¼‰\n';
      content += '- é£²æ–™åç¨±ï¼šé£²æ–™çš„åç¨±ï¼ˆå¿…å¡«ï¼‰\n';
      content += '- åƒ¹æ ¼ï¼šé£²æ–™çš„åƒ¹æ ¼ï¼Œåªå¡«æ•¸å­—ï¼ˆå¿…å¡«ï¼‰\n\n';
      content += 'ç¯„ä¾‹èœå–®ï¼š\n';
      content += '-'.repeat(25) + '\n';
      content += 'é£²æ–™åº—åç¨±,é£²æ–™åç¨±,åƒ¹æ ¼\n';
      content += templateData.map(item => `${item.store},${item.name},${item.price}`).join('\n');
      content += '\n\n';
      content += 'ä½¿ç”¨èªªæ˜ï¼š\n';
      content += '1. è¤‡è£½ä¸Šæ–¹ç¯„ä¾‹èœå–®å…§å®¹\n';
      content += '2. ä¿®æ”¹é£²æ–™åº—åç¨±ã€é£²æ–™åç¨±å’Œåƒ¹æ ¼\n';
      content += '3. å„²å­˜ç‚º .csv æª”æ¡ˆ\n';
      content += '4. åœ¨ç³»çµ±ä¸­ä¸Šå‚³ CSV æª”æ¡ˆ\n';
      content += '5. ç³»çµ±æœƒè‡ªå‹•é¡¯ç¤ºæ‚¨çš„é£²æ–™åº—åç¨±\n';
      mimeType = 'text/plain;charset=utf-8';
      extension = 'txt';
      break;
  }

  filename = `èœå–®ç¯„æœ¬_${dateStr}_${timeStr}.${extension}`;

  // å»ºç«‹ä¸¦ä¸‹è¼‰æª”æ¡ˆ
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  const formatNames = {
    'csv': 'CSV',
    'excel': 'Excel ç›¸å®¹ CSV',
    'json': 'JSON',
    'txt': 'æ–‡å­—'
  };

  alert(`âœ… ${formatNames[format]} æ ¼å¼èœå–®ç¯„æœ¬å·²ä¸‹è¼‰ï¼\næª”æ¡ˆåç¨±ï¼š${filename}\n\nåŒ…å« ${templateData.length} å€‹ç¯„ä¾‹é£²æ–™é …ç›®ï¼Œè«‹ä¿®æ”¹å¾Œä¸Šå‚³ä½¿ç”¨ã€‚`);
}

// é¡¯ç¤ºç·¨è¼¯èœå–®
function showEditMenu(store) {
  currentEditStore = store;
  editingMenu = JSON.parse(JSON.stringify(menus[store] || [])); // æ·±æ‹·è²

  const container = document.getElementById('menu-edit-list');

  if (editingMenu.length === 0) {
    container.innerHTML = '<p>æ­¤åº—å®¶ç›®å‰æ²’æœ‰èœå–®é …ç›®</p>';
    return;
  }

  let html = '';
  editingMenu.forEach((item, index) => {
    html += `
      <div class="edit-item" data-index="${index}">
        <input type="text" value="${item.name}" placeholder="é£²æ–™åç¨±" onchange="updateDrinkName(${index}, this.value)" />
        <span>$</span>
        <input type="number" class="price-input" value="${item.price}" min="0" placeholder="åƒ¹æ ¼" onchange="updateDrinkPrice(${index}, this.value)" />
        <button class="delete-btn" onclick="deleteDrink(${index})">ğŸ—‘ï¸</button>
      </div>
    `;
  });

  container.innerHTML = html;
}

// æ›´æ–°é£²æ–™åç¨±
function updateDrinkName(index, name) {
  if (editingMenu[index]) {
    editingMenu[index].name = name.trim();
  }
}

// æ›´æ–°é£²æ–™åƒ¹æ ¼
function updateDrinkPrice(index, price) {
  if (editingMenu[index]) {
    editingMenu[index].price = parseInt(price) || 0;
  }
}

// åˆªé™¤é£²æ–™
function deleteDrink(index) {
  if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é£²æ–™é …ç›®å—ï¼Ÿ')) {
    editingMenu.splice(index, 1);
    showEditMenu(currentEditStore);
  }
}

// æ–°å¢é£²æ–™
function addNewDrink() {
  if (!currentEditStore) {
    alert('è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯çš„åº—å®¶ï¼');
    return;
  }

  const name = prompt('è«‹è¼¸å…¥æ–°é£²æ–™åç¨±ï¼š');
  if (!name || !name.trim()) return;

  const price = prompt('è«‹è¼¸å…¥åƒ¹æ ¼ï¼š');
  const priceNum = parseInt(price);
  if (isNaN(priceNum) || priceNum < 0) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼ï¼');
    return;
  }

  editingMenu.push({
    name: name.trim(),
    price: priceNum
  });

  showEditMenu(currentEditStore);
}

// å„²å­˜èœå–®è®Šæ›´
function saveMenuChanges() {
  if (!currentEditStore) {
    alert('è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯çš„åº—å®¶ï¼');
    return;
  }

  // é©—è­‰è³‡æ–™
  const validItems = editingMenu.filter(item => item.name && item.name.trim() && item.price >= 0);

  if (validItems.length === 0) {
    alert('è«‹è‡³å°‘ä¿ç•™ä¸€å€‹æœ‰æ•ˆçš„é£²æ–™é …ç›®ï¼');
    return;
  }

  if (confirm(`ç¢ºå®šè¦å„²å­˜å° ${getStoreName(currentEditStore)} èœå–®çš„è®Šæ›´å—ï¼Ÿ\n\nå°‡æœƒæ›´æ–° ${validItems.length} å€‹é£²æ–™é …ç›®ã€‚`)) {
    // æ›´æ–°èœå–®
    menus[currentEditStore] = validItems;

    // å¦‚æœç•¶å‰æ­£åœ¨é¡¯ç¤ºé€™å€‹åº—å®¶çš„èœå–®ï¼Œé‡æ–°è¼‰å…¥
    const currentStore = document.getElementById('store-select').value;
    if (currentStore === currentEditStore) {
      currentMenu = menus[currentEditStore];
      showMenu(currentMenu);
    }

    alert(`âœ… ${getStoreName(currentEditStore)} çš„èœå–®å·²æˆåŠŸæ›´æ–°ï¼`);
    closeMenuEditModal();
  }
}

// é—œé–‰ç·¨è¼¯è¦–çª—
function closeMenuEditModal() {
  document.getElementById('menu-edit-modal').style.display = 'none';
  document.getElementById('edit-store-select').value = '';
  document.getElementById('menu-edit-list').innerHTML = '<p>è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯çš„åº—å®¶</p>';
  currentEditStore = '';
  editingMenu = [];
}

// ç²å–åº—å®¶åç¨±
function getStoreName(storeId) {
  const storeNames = {
    'milkshop': 'è¿·å®¢å¤ Milk Shop',
    '50lan': '50åµ',
    'comebuy': 'æ¸…å¿ƒç¦å…¨',
    'gongcha': 'è²¢èŒ¶',
    'truedan': 'çç…®ä¸¹',
    'songben': 'èŒ¶ä¹‹é­”æ‰‹',
    'seventea': 'ä¸ƒç›èŒ¶',
    'dejeng': 'å¾—æ­£',
    'yimuday': 'ä¸€æ²æ—¥'
  };
  return storeNames[storeId] || storeId;
}

</script>
</html>
